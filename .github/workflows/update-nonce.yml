---
name: Update Nonce on Issue Open

'on':
  issues:
    types: [opened]

jobs:
  update-nonce:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read

    steps:
      - name: Check if issue body contains "nonce"
        id: check-nonce
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          if echo "$ISSUE_BODY" | grep -qi "nonce"; then
            echo "contains_nonce=true" >> $GITHUB_OUTPUT
            echo "Issue body contains 'nonce' - proceeding"
          else
            echo "contains_nonce=false" >> $GITHUB_OUTPUT
            echo "Issue body does not contain 'nonce' - stopping"
          fi

      - name: Checkout repository
        if: steps.check-nonce.outputs.contains_nonce == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update nonce in README
        if: steps.check-nonce.outputs.contains_nonce == 'true'
        run: |
          # Generate a random 6-digit number
          NEW_NONCE=$(printf "%06d" $((RANDOM % 1000000)))
          echo "Generated new nonce: $NEW_NONCE"

          # Get current timestamp in UTC
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          echo "Current timestamp: $TIMESTAMP"

          # Find and replace nonce=NNNNNN pattern with new nonce
          # Only within the NONCE section markers
          # MATCHING INVARIANT FOR NONCE: Must be exactly "nonce=" followed by
          # exactly 6 digits (e.g., nonce=019757). You can change text/styling
          # around it, but the pattern "nonce=[0-9]{6}" must remain intact.
          NONCE_PATTERN='/<!-- NONCE -->/,/<!-- NONCE-END -->/'
          NONCE_REPLACEMENT='s/nonce=[0-9]\{6\}/nonce='"$NEW_NONCE"'/g'
          sed -i "${NONCE_PATTERN}${NONCE_REPLACEMENT}" README.md

          # Update the timestamp in the visual indicator
          # MATCHING INVARIANT FOR TIMESTAMP: Must be exactly "Last updated: `"
          # followed by any characters, followed by "`" (backtick).
          # The text between backticks can be any format, but the pattern
          # "Last updated: `...`" must remain intact (including backticks).
          TS_REPL='s/Last updated: `[^`]*`/Last updated: `'"$TIMESTAMP"'`/g'
          sed -i "${NONCE_PATTERN}${TS_REPL}" README.md

          echo "Updated README.md with new nonce value and timestamp"

      - name: Commit and push changes
        if: steps.check-nonce.outputs.contains_nonce == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update nonce value in README [skip ci]"
            git push
          fi
